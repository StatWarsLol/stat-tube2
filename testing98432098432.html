<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Log In to StatTube</title>
    <!-- CSP: Allow unsafe-inline for this file, block other domains -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src https://api.stat-tube.com; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data:;">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; background-color: #f8f9fa; -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body>
    <!-- The only element visible to the main DOM -->
    <div id="st-secure-mount"></div>

    <script>
    (function() {
        'use strict';

        // --- SECURITY CORE ---
        // 1. MEMORY STORAGE: The key lives here. Not in LocalStorage.
        // Tampermonkey cannot access variables inside this IIFE closure.
        let _RAM_KEY = null;

        // 2. HONEYPOT: We put a fake key in LocalStorage to trick scripts.
        if (localStorage.getItem('userApiKey') !== '0000-INVALID-BOT-KEY') {
            localStorage.setItem('userApiKey', '0000-INVALID-BOT-KEY');
        }

        const MOUNT_ID = 'st-secure-mount';
        const API_URL = 'https://api.stat-tube.com';

        // --- TEMPLATE ---
        const templateContent = `
            <style>
                :host { display: block; all: initial; font-family: 'Inter', sans-serif; }
                .wrapper { font-family: 'Inter', sans-serif; color: #495057; background-color: #f8f9fa; width: 100%; min-height: 100vh; }
                .section-wrapper { background-color: #ffffff; }
                .content-container { max-width: 840px; margin: 0 auto; padding: 1.5rem 2rem; box-sizing: border-box; }
                .header-content { display: flex; justify-content: space-between; align-items: center; }
                .section-divider { border: none; height: 1px; background-color: #e9ecef; margin: 0; }
                .logo { height: 48px; width: auto; }
                h2 { color: #0d6efd; font-size: 2rem; font-weight: 700; margin: 0 0 0.5rem 0; }
                p { font-size: 1.1rem; line-height: 1.6; margin: 0 0 1.5rem 0; }
                .sub-text { font-size: 1.2rem; color: #6c757d; }
                .button-group { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1rem; }
                
                button { font-family: 'Inter', sans-serif; }
                
                .connect-button { 
                    font-size: 1rem; font-weight: 700; color: #fff; 
                    background: linear-gradient(135deg, #0d6efd, #0b5ed7); 
                    border: none; padding: 0.8rem 1.5rem; border-radius: 8px; 
                    cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease;
                }
                .connect-button:hover:not(:disabled) { 
                    transform: translateY(-2px); box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3); 
                }
                .connect-button:disabled { background: #6c757d; cursor: not-allowed; }
                
                .logout-button { background: #6c757d; border: none; color: white; padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; }
                
                .hidden { display: none !important; }
                
                #box-instructions { margin-top: 2rem; border-top: 1px solid #e9ecef; padding-top: 2rem; }
                #connect-command { font-family: monospace; font-size: 1.4rem; color: #dc3545; text-align: center; background: #e9ecef; padding: 1rem; border-radius: 8px; margin-bottom: 10px; word-break: break-all; }
                .footer-content { text-align: right; padding: 1.5rem 0; color: #adb5bd; font-size: 0.9rem; }
            </style>

            <div class="wrapper">
                <header class="section-wrapper">
                    <div class="content-container header-content">
                        <img src="./stm.png" alt="StatTube Logo" class="logo">
                        <span style="font-weight:700; font-size: 1.2rem;">StatTube</span>
                    </div>
                </header>
                <hr class="section-divider">
                <main class="section-wrapper">
                    <div class="content-container">
                        <!-- LOGGED OUT -->
                        <div id="view-logged-out">
                            <h2>Log In to StatTube</h2>
                            <p class="sub-text" id="txt-login-sub">You aren't logged in yet. Let's fix that.</p>
                            <button class="connect-button" id="btn-connect">Connect Account</button>
                            
                            <div id="box-instructions" class="hidden">
                                <p><strong>1.</strong> Copy the command below.<br><strong>2.</strong> Paste it in YouTube chat.<br><strong>3.</strong> Wait here!</p>
                                <div id="connect-command"></div>
                                <button class="connect-button" style="background:#dee2e6; color:#495057;" id="btn-copy">Copy to Clipboard</button>
                                <p id="status-poll" style="text-align: center; margin-top: 1rem; color: #6c757d;">Waiting...</p>
                            </div>
                        </div>

                        <!-- LOGGED IN -->
                        <div id="view-logged-in" class="hidden">
                            <h2>Upload</h2>
                            <p class="sub-text">You are logged in.</p>
                            <div class="button-group">
                                <button class="connect-button" data-cmd="video">Publish !video</button>
                                <button class="connect-button" data-cmd="short">Publish !short</button>
                                <button class="connect-button" data-cmd="stream">Publish !stream</button>
                                <button class="connect-button" data-cmd="song">Publish !song</button>
                                <button class="connect-button" data-cmd="post">Publish !post</button>
                                <button class="connect-button" data-cmd="viral">Publish !viral</button>
                                <button class="connect-button" data-cmd="trend">Publish !trend</button>
                            </div>
                            <button class="logout-button" id="btn-logout">Log Out</button>
                            <p id="status-publish" style="margin-top:1rem; font-weight:600;"></p>
                        </div>
                    </div>
                </main>
                <footer class="section-wrapper">
                    <div class="content-container footer-content">StatTube (CT) V1.40</div>
                </footer>
            </div>
        `;

        // --- SHADOW DOM SETUP ---
        const mountPoint = document.getElementById(MOUNT_ID);
        const shadowRoot = mountPoint.attachShadow({ mode: 'closed' }); // Closed mode blocks JS access
        shadowRoot.innerHTML = templateContent;

        // --- DEFENSE: DOM WATCHER ---
        // If script deletes mount point, reload.
        new MutationObserver((mutations) => {
            mutations.forEach((m) => {
                m.removedNodes.forEach((node) => {
                    if (node.id === MOUNT_ID) location.reload();
                });
            });
        }).observe(document.body, { childList: true });

        // --- INTERNAL REFERENCES ---
        const els = {
            viewOut: shadowRoot.getElementById('view-logged-out'),
            viewIn: shadowRoot.getElementById('view-logged-in'),
            btnConnect: shadowRoot.getElementById('btn-connect'),
            boxInst: shadowRoot.getElementById('box-instructions'),
            txtCmd: shadowRoot.getElementById('connect-command'),
            btnCopy: shadowRoot.getElementById('btn-copy'),
            statusPoll: shadowRoot.getElementById('status-poll'),
            btnLogout: shadowRoot.getElementById('btn-logout'),
            statusPub: shadowRoot.getElementById('status-publish'),
            subText: shadowRoot.getElementById('txt-login-sub')
        };

        let pollingInterval = null;

        function updateView() {
            if (_RAM_KEY) {
                els.viewOut.classList.add('hidden');
                els.viewIn.classList.remove('hidden');
            } else {
                els.viewIn.classList.add('hidden');
                els.viewOut.classList.remove('hidden');
            }
        }

        async function attemptAuthCheck() {
            // Check session token from RAM or SessionStorage (obfuscated) if needed
            // For now, using sessionToken from LocalStorage is okay because it's only for the initial handshake
            const token = localStorage.getItem('sessionToken');
            if (!token) return;

            try {
                const res = await fetch(`${API_URL}/auth/status?sessionToken=${token}`);
                const data = await res.json();
                
                if (data.status === 'completed') {
                    clearInterval(pollingInterval);
                    localStorage.removeItem('sessionToken'); // Remove handshake token
                    
                    // --- CRITICAL DEFENSE ---
                    // Save key to RAM ONLY. 
                    // Do NOT save to localStorage.setItem('userApiKey')
                    _RAM_KEY = data.userApiKey; 
                    
                    els.btnConnect.style.display = 'inline-block';
                    els.subText.style.display = 'block';
                    els.boxInst.classList.add('hidden');
                    els.btnConnect.disabled = false;
                    els.btnConnect.textContent = 'Connect Account';
                    
                    updateView();
                }
            } catch (e) { console.error(e); }
        }

        const isHuman = (e) => e.isTrusted;

        els.btnConnect.addEventListener('click', async (e) => {
            if(!isHuman(e)) return;
            els.btnConnect.disabled = true;
            els.btnConnect.textContent = 'Generating...';
            try {
                const res = await fetch(`${API_URL}/auth/generate-code`);
                const data = await res.json();
                localStorage.setItem('sessionToken', data.sessionToken);
                
                els.txtCmd.textContent = `!connect ${data.connectCode}`;
                els.btnConnect.style.display = 'none';
                els.subText.style.display = 'none';
                els.boxInst.classList.remove('hidden');
                
                pollingInterval = setInterval(attemptAuthCheck, 3000);
            } catch (err) {
                alert('Connection failed');
                els.btnConnect.disabled = false;
            }
        });

        els.btnCopy.addEventListener('click', (e) => {
            if(!isHuman(e)) return;
            navigator.clipboard.writeText(els.txtCmd.innerText);
            els.btnCopy.textContent = "Copied!";
            setTimeout(() => els.btnCopy.textContent = "Copy to Clipboard", 2000);
        });

        els.btnLogout.addEventListener('click', (e) => {
            if(!isHuman(e)) return;
            _RAM_KEY = null; // Clear RAM key
            localStorage.setItem('userApiKey', '0000-INVALID-BOT-KEY'); // Reset honeypot
            clearInterval(pollingInterval);
            updateView();
        });

        shadowRoot.querySelectorAll('.button-group button').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                if(!isHuman(e)) return;
                const cmd = btn.getAttribute('data-cmd');
                
                // USE RAM KEY ONLY
                if(!_RAM_KEY) {
                    alert("Session expired. Please reconnect.");
                    location.reload();
                    return;
                }

                btn.disabled = true;
                els.statusPub.textContent = `Publishing !${cmd}...`;
                els.statusPub.style.color = "#495057";

                try {
                    const res = await fetch(`${API_URL}/publish/${cmd}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userApiKey: _RAM_KEY }) // Send RAM key
                    });
                    const d = await res.json();
                    if(!res.ok) throw new Error(d.error || 'Error');
                    els.statusPub.textContent = "Success!";
                    els.statusPub.style.color = "#198754";
                } catch(err) {
                    els.statusPub.textContent = err.message;
                    els.statusPub.style.color = "#dc3545";
                } finally {
                    setTimeout(() => btn.disabled = false, 1000);
                }
            });
        });

        // NOTE: Since we are using RAM keys, if the user refreshes, they are logged out.
        // This is the trade-off for blocking the Tampermonkey script.
        updateView();

    })();
    </script>
</body>
</html>
