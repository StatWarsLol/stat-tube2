<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hehe this is a statistical war</title>
    <!-- Import Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --yt-bg: #0f0f0f;
            --yt-bg-glass: rgba(15, 15, 15, 0.98);
            --yt-text: #ffffff;
            --yt-secondary: #aaaaaa;
            --yt-border: #333333;
            --yt-chip-bg: #272727;
            --studio-bg: #212121;
            --yt-blue: #3ea6ff;
            --dropdown-bg: #282828;
            --odo-easing: cubic-bezier(0.45, 0.05, 0.55, 0.95);
            --spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --font-main: 'Inter', sans-serif;
            /* Added variable to sync Odometer heights */
            --odo-h: 140px;
        }

        /* --- LIGHT MODE OVERRIDES --- */
        body.light-mode {
            --yt-bg: #ffffff;
            --yt-bg-glass: rgba(255, 255, 255, 0.98);
            --yt-text: #0f0f0f;
            --yt-secondary: #606060;
            --yt-border: #e5e5e5;
            --yt-chip-bg: #f2f2f2;
            --studio-bg: #f9f9f9;
            --yt-blue: #065fd4;
            --dropdown-bg: #ffffff;
        }

        body {
            background-color: var(--yt-bg);
            color: var(--yt-text);
            font-family: var(--font-main);
            margin: 0; padding: 0;
            overflow-x: hidden;
            transition: background-color 0.2s, color 0.2s;
        }

        /* --- BRANDING --- */
        .brand-text {
            font-weight: 800;
            font-size: 22px;
            background: linear-gradient(to bottom, #0044ff, #00a2ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
            letter-spacing: -0.5px;
        }

        /* --- LOADING ANIMATIONS --- */
        .sync-text {
            font-weight: 600;
            font-size: 18px;
            background: linear-gradient(90deg, var(--yt-secondary), var(--yt-text), var(--yt-secondary));
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: textShine 2s linear infinite;
        }

        @keyframes textShine {
            to { background-position: 200% center; }
        }

        .aurora-line { position: relative; }
        .aurora-line::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, var(--yt-secondary) 25%, var(--yt-text) 50%, var(--yt-secondary) 75%, transparent 100%);
            background-size: 200% 100%;
            animation: auroraBorealis 3s linear infinite;
            filter: blur(1px);
            z-index: 10;
        }

        @keyframes auroraBorealis {
            0% { background-position: 200% 0; opacity: 0.3; }
            50% { opacity: 0.8; }
            100% { background-position: -200% 0; opacity: 0.3; }
        }

        /* --- HEADER --- */
        .header {
            position: sticky;
            top: 0;
            background-color: var(--yt-bg-glass);
            backdrop-filter: blur(12px);
            padding: 8px 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--yt-border);
            height: 56px;
        }

        .header-left, .header-right { display: flex; align-items: center; gap: 15px; flex: 1; }
        .header-center { flex: 2; display: flex; justify-content: center; }
        .header-right { justify-content: flex-end; position: relative; }

        .back-btn { background: #272727; border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: none; }
        .back-btn:hover { background: #3f3f3f; }

        .search-container { display: flex; width: 100%; max-width: 500px; }
        .search-container input {
            flex: 1; background-color: #121212; border: 1px solid var(--yt-border);
            color: white; padding: 0 16px; border-radius: 40px 0 0 40px; outline: none;
            height: 40px; font-family: var(--font-main);
        }
        body.light-mode .search-container input { background-color: white; color: black; border-color: #ccc; }
        
        .search-container button {
            background-color: #222; border: 1px solid var(--yt-border); border-left: none;
            color: white; padding: 0 20px; border-radius: 0 40px 40px 0; cursor: pointer;
        }
        body.light-mode .search-container button { background-color: #f8f8f8; color: black; border-color: #ccc; }

        /* --- AUTH & PFP --- */
        .signin-btn {
            background: none; border: 1px solid var(--yt-border); color: var(--yt-blue);
            padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: 500;
            font-size: 14px; display: flex; align-items: center; gap: 8px;
        }
        .user-pfp-btn { width: 34px; height: 34px; border-radius: 50% !important; cursor: pointer; object-fit: cover; }

        /* --- DROPDOWN --- */
        .dropdown { display: none; position: absolute; top: 50px; right: 0; width: 300px; background: var(--dropdown-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 30px rgba(0,0,0,0.5); z-index: 5000; }
        .dropdown.show { display: block; animation: popIn 0.2s ease-out; }
        .dropdown-header { display: flex; gap: 16px; padding: 16px; border-bottom: 1px solid var(--yt-border); }
        .dropdown-header img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .dropdown-item { display: flex; align-items: center; gap: 16px; padding: 10px 16px; cursor: pointer; font-size: 14px; color: var(--yt-text); }
        .dropdown-item:hover { background: rgba(128, 128, 128, 0.1); }

        /* --- BUTTON FIX --- */
        .btn-gray {
            background-color: #272727 !important;
            color: #ffffff !important;
            border: none !important;
            padding: 10px 18px !important;
            border-radius: 20px !important;
            cursor: pointer !important;
            font-weight: 500 !important;
            font-family: var(--font-main) !important;
            font-size: 14px !important;
            margin-top: 12px !important;
            transition: background-color 0.2s !important;
            display: inline-block !important;
            text-align: center !important;
            text-decoration: none !important;
        }
        .btn-gray:hover { background-color: #3f3f3f !important; }
        body.light-mode .btn-gray { background-color: #f2f2f2 !important; color: black !important; }

        /* --- FILTERS & TABS --- */
        .filters-container { padding: 12px 20px; background-color: var(--yt-bg); position: sticky; top: 56px; z-index: 999; overflow-x: auto; white-space: nowrap; display: flex; gap: 12px; scrollbar-width: none; border-bottom: 1px solid var(--yt-border); }
        .filters-container::-webkit-scrollbar { display: none; }
        .chip { background-color: var(--yt-chip-bg); color: var(--yt-text); padding: 6px 14px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; border: none; font-family: var(--font-main); }
        .chip.active { background-color: var(--yt-text); color: var(--yt-bg); }

        .tabs-row { display: flex; gap: 10px; border-bottom: 1px solid var(--yt-border); margin: 20px 0; overflow-x: auto; white-space: nowrap; }
        .tab { padding: 12px 20px; cursor: pointer; color: var(--yt-secondary); font-weight: 500; text-transform: capitalize; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab.active { color: var(--yt-text); border-bottom: 3px solid var(--yt-text); }

        .content { padding: 0 20px 20px 20px; max-width: 1280px; margin: 0 auto; }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 10px; }
        
        @keyframes popIn { from { opacity: 0; transform: scale(0.9) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .video-card { cursor: pointer; opacity: 0; animation: popIn 0.5s var(--spring) forwards; }
        
        .thumbnail { width: 100%; aspect-ratio: 16/9; border-radius: 12px; margin-bottom: 12px; position: relative; overflow: hidden; border: 1px solid var(--yt-border); display: flex; align-items: center; justify-content: center; }
        .thumb-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: transform 0.4s ease; z-index: 0; }
        .video-card:hover .thumb-bg { transform: scale(1.05); }
        .thumb-overlay-pfp { position: relative; z-index: 1; width: 35%; aspect-ratio: 1/1; border-radius: 50% !important; object-fit: cover; opacity: 0.5; }

        .details { display: flex; gap: 12px; }
        .details img { width: 36px; height: 36px; border-radius: 50% !important; object-fit: cover; flex-shrink: 0; }
        .title { font-size: 14px; margin: 0; line-height: 1.4; font-weight: 500; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .meta { color: var(--yt-secondary); font-size: 12px; margin-top: 4px; }

        /* --- PROFILE VIEW --- */
        #channelProfileView { display: none; padding-top: 20px; opacity: 0; transition: opacity 0.5s; }
        .profile-header { display: flex; gap: 30px; align-items: center; }
        .profile-pfp-circle { width: 160px; height: 160px; border-radius: 50% !important; object-fit: cover; box-shadow: 0 4px 20px rgba(0,0,0,0.6); flex-shrink: 0; }
        .profile-info h1 { font-size: 36px; margin: 0; font-weight: 800; }

        /* --- ODOMETER STUDIO --- */
        #liveSubCountView { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--studio-bg); z-index: 8000; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.5s ease; }
        .odometer-container { display: flex; justify-content: center; align-items: center; height: var(--odo-h); overflow: hidden; font-size: calc(var(--odo-h) * 0.9); font-weight: 800; letter-spacing: -3px; }
        .odo-digit { width: 0.62em; height: var(--odo-h); overflow: hidden; position: relative; }
        .odo-reel { display: flex; flex-direction: column; }
        .odo-reel span { display: block; height: var(--odo-h); text-align: center; }

        /* --- MODAL --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 6000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: #282828; width: 90%; max-width: 500px; border-radius: 12px; padding: 24px; position: relative; }
        body.light-mode .modal-content { background: white; color: black; }
        .modal-close { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--yt-text); font-size: 24px; cursor: pointer; }
        .publish-input { width: 100%; padding: 12px; background: #121212; border: 1px solid #444; border-radius: 8px; color: white; margin-bottom: 20px; box-sizing: border-box; font-family: var(--font-main); outline: none; }
        body.light-mode .publish-input { background: #f9f9f9; color: black; border-color: #ddd; }
        .pub-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .pub-btn { background: #3f3f3f; border: none; color: white; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; position: relative; overflow: hidden; transition: 0.2s; }
        body.light-mode .pub-btn { background: #f2f2f2; color: black; }
        .pub-btn:hover:not(.in-cooldown) { background: #555; }
        .pub-btn .btn-slider { position: absolute; bottom: 0; left: 0; height: 3px; width: 0%; background: var(--yt-blue); transition: none; }
        .pub-btn.in-cooldown .btn-slider { width: 100%; transition: width 2s linear; }
        .pub-btn.in-cooldown { background: #222; opacity: 0.5; pointer-events: none; }
        
        .hidden { display: none !important; }
        .channel-search-row { display: flex; gap: 50px; padding: 24px 0; border-bottom: 1px solid var(--yt-border); cursor: pointer; text-decoration: none; color: inherit; }
        .search-pfp { width: 136px; height: 136px; border-radius: 50%; }

        /* --- MOBILE RESPONSIVE QUERIES --- */
        @media (max-width: 768px) {
            :root { --odo-h: 70px; } /* Smaller odometer for mobile */
            .header { padding: 8px 10px; }
            .brand-text { display: none; }
            .header-left { gap: 8px; flex: 0; }
            .header-right { gap: 10px; }
            .create-btn span { display: none; }
            .create-btn { padding: 0 10px !important; }
            
            .profile-header { flex-direction: column; text-align: center; gap: 15px; }
            .profile-pfp-circle { width: 100px; height: 100px; }
            .profile-info h1 { font-size: 24px; }
            
            .channel-search-row { flex-direction: column; gap: 15px; align-items: center; text-align: center; }
            .search-pfp { width: 100px; height: 100px; }
            
            .video-grid { grid-template-columns: 1fr; }
            .content { padding: 0 10px 10px 10px; }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-left">
            <button class="back-btn" id="backBtn">←</button>
            <div style="display: flex; align-items: center; cursor: pointer; gap: 8px;" onclick="location.reload()">
                <img src="https://stat-tube.com/stm.png" alt="S" style="height: 32px; width: auto;">
                <span class="brand-text">StatTube</span>
            </div>
        </div>
        <div class="header-center"><div class="search-container"><input type="text" id="searchInput" placeholder="Search"><button id="searchBtn">Search</button></div></div>
        <div class="header-right" id="authHeader"></div>
    </header>

    <div class="dropdown" id="userDropdown">
        <div id="dropdownContent"></div>
        <div style="border-top:1px solid var(--yt-border); margin:8px 0;"></div>
        <div class="dropdown-item" id="themeToggleBtn" onclick="toggleTheme(); event.stopPropagation();"></div>
        <div class="dropdown-item" onclick="handleLogout()">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor" style="margin-right:12px;">
                <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"></path>
            </svg>
            Sign out
        </div>
    </div>

    <div class="modal-overlay" id="authModal">
        <div class="modal-content"><button class="modal-close" onclick="togglePublishModalClose()">×</button>
            <div id="modalLoggedOut"><h2 style="margin-top: 0;">Connect Account</h2><button class="pub-btn" style="width:100%; background: var(--yt-blue); color: black;" id="genAuthBtn">Generate Code</button><div id="authInstr" class="hidden" style="margin-top: 20px; padding: 15px; background: #121212; border-radius: 8px; text-align: center;"><div id="authCodeDisp" style="font-family: monospace; font-size: 20px; color: #ff4e4e; margin-bottom: 10px;"></div><button class="pub-btn" onclick="copyAuthCode()">Copy Command</button></div></div>
            <div id="modalLoggedIn" class="hidden"><h2 style="margin-top: 0;">Publish Content</h2><input type="text" class="publish-input" id="pubTitle" placeholder="Video Title (min. 5 chars)"><div class="pub-grid"><button class="pub-btn" onclick="publishCmd('video', this)">!video<div class="btn-slider"></div></button><button class="pub-btn" onclick="publishCmd('short', this)">!short<div class="btn-slider"></div></button><button class="pub-btn" onclick="publishCmd('stream', this)">!stream<div class="btn-slider"></div></button><button class="pub-btn" onclick="publishCmd('song', this)">!song<div class="btn-slider"></div></button><button class="pub-btn" onclick="publishCmd('post', this)">!post<div class="btn-slider"></div></button><button class="pub-btn" onclick="publishCmd('trend', this)">!trend<div class="btn-slider"></div></button></div><p id="pubStatus" style="font-size: 13px; text-align: center; margin-top: 15px;"></p></div>
        </div>
    </div>

    <div id="liveSubCountView">
        <button onclick="closeStudio()" style="position:absolute; top:20px; right:20px; background:none; border:none; color:white; font-size:40px; cursor:pointer;">×</button>
        <img src="" id="studioPfp" class="studio-pfp" style="width:120px; height:120px; margin-bottom:20px; border:3px solid #444; border-radius: 50%; object-fit: cover;">
        <div id="studioName" style="font-size:28px; font-weight: 600; margin-bottom: 40px; text-align: center;"></div>
        <div class="odometer-container" id="odometer"></div>
        <div style="font-size:22px; color:var(--yt-secondary); text-transform:uppercase; font-weight: 600; letter-spacing:2px; margin-top:10px;">Subscribers</div>
    </div>

    <div class="content">
        <div id="mainView">
            <div class="filters-container aurora-line" id="filtersRow">
                <button class="chip active" onclick="filterMainFeed('All', this)">All</button>
            </div>
            <div id="channelResults"></div>
            <div id="loading" style="text-align:center; padding:40px;"><span id="loadingSpan" class="sync-text">Loading...</span></div>
            <div class="video-grid" id="videoGrid"></div>
        </div>
        <div id="channelProfileView">
            <div id="profileTop"></div>
            <div class="tabs-row" id="tabsRow"></div>
            <div class="video-grid" id="channelVideoGrid"></div>
        </div>
    </div>

    <script>
        const API_URL = 'https://api.stat-tube.com';
        const STORAGE_REAL = '_st_sys_config_x9';
        const encrypt = (t) => btoa(t.split('').reverse().join(''));
        const decrypt = (t) => atob(t).split('').reverse().join('');
        let allVideos = []; let usersData = {}; let currentHandle = null; let activeFilter = "All"; let pollInterval = null;
        const defaultPfp = 'https://stat-tube.com/stm.png'; const digitState = [];

        let isDarkMode = localStorage.getItem('theme') !== 'light';

        function applyTheme() {
            const iconStr = isDarkMode ? 
                `<svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor" style="margin-right:12px;"><path d="M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36c-0.98,1.37-2.58,2.26-4.4,2.26 c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg>` : 
                `<svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor" style="margin-right:12px;"><path d="M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5S14.76,7,12,7L12,7z M2,13h2c0.55,0,1-0.45,1-1s-0.45-1-1-1H2 c-0.55,0-1,0.45-1,1S1.45,13,2,13L2,13z M20,13h2c0.55,0,1-0.45,1-1s-0.45-1-1-1h-2c-0.55,0-1,0.45-1,1S19.45,13,20,13L20,13z M11,2v2 c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2L11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1 S11,19.45,11,20L11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0s-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0 s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95c-0.39-0.39-1.03-0.39-1.41,0s-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.02,0.39,1.41,0 s0.39-1.03,0-1.41L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41s-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41s-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L7.05,18.36z"></path></svg>`;
            const label = isDarkMode ? "Appearance: Dark" : "Appearance: Light";
            document.body.classList.toggle('light-mode', !isDarkMode);
            const btn = document.getElementById('themeToggleBtn');
            if (btn) btn.innerHTML = `${iconStr}<span>${label}</span>`;
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            applyTheme();
        }

        function filterMainFeed(cmd, btn) {
            document.querySelectorAll('#filtersRow .chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            activeFilter = cmd;
            renderFeed();
        }

        const Auth = {
            login: (key, cid) => { localStorage.setItem(STORAGE_REAL, encrypt(key)); localStorage.setItem('myCid', cid); updateAuthUI(); },
            getKey: () => { const blob = localStorage.getItem(STORAGE_REAL); return blob ? decrypt(blob) : null; },
            logout: () => { localStorage.removeItem(STORAGE_REAL); localStorage.removeItem('myCid'); location.reload(); }
        };

        function toggleUserDropdown() { document.getElementById('userDropdown').classList.toggle('show'); }
        function togglePublishModal() { document.getElementById('authModal').style.display = 'flex'; }
        function togglePublishModalClose() { document.getElementById('authModal').style.display = 'none'; }

        async function updateAuthUI() {
            const key = Auth.getKey(); const cid = localStorage.getItem('myCid');
            const header = document.getElementById('authHeader'); const dropContent = document.getElementById('dropdownContent');
            if (key && cid) {
                const userEntry = Object.entries(usersData).find(([h, d]) => d.channelId === cid);
                const user = userEntry ? userEntry[1] : { displayName: "User", profilePicture: defaultPfp };
                const handle = userEntry ? userEntry[0] : "@unknown";
                header.innerHTML = `<button class="create-btn" style="background:var(--yt-chip-bg); border:none; color:var(--yt-text); padding:0 16px; height:36px; border-radius:18px; cursor:pointer; font-weight:500; display:flex; align-items:center; gap:8px; margin-right:15px;" onclick="togglePublishModal()"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M14,13h-3v3H9v-3H6v-2h3V8h2v3h3V13z M17,6H3v12h14v-6.39l4,3.83V8.56l-4,3.83V6z M18,5v5.51L22,7v10l-4-3.51V19H2V5H18z"></path></svg><span>Create</span></button><img src="${user.profilePicture}" class="user-pfp-btn" onclick="toggleUserDropdown()" onerror="this.src='${defaultPfp}';">`;
                dropContent.innerHTML = `<div class="dropdown-header"><img src="${user.profilePicture}" onerror="this.src='${defaultPfp}';"><div class="dropdown-user-info"><h4 style="margin:0">${user.displayName}</h4><p style="margin:2px 0">${handle}</p><a href="#" style="color:var(--yt-blue); text-decoration:none; font-size:14px;" onclick="openChannel('${cid}'); toggleUserDropdown(); return false;">View your channel</a></div></div>`;
                document.getElementById('modalLoggedOut').classList.add('hidden'); document.getElementById('modalLoggedIn').classList.remove('hidden');
            } else {
                header.innerHTML = `<button class="signin-btn" onclick="togglePublishModal()">Sign In</button>`;
                document.getElementById('modalLoggedOut').classList.remove('hidden'); document.getElementById('modalLoggedIn').classList.add('hidden');
            }
            applyTheme();
        }

        async function init() {
            applyTheme();
            
            let loadingTimeout = setTimeout(() => {
                const span = document.getElementById('loadingSpan');
                if (span) {
                    span.innerText = "Not loading? Check your internet connection.";
                    span.style.color = "#ff4e4e";
                    span.classList.remove('sync-text');
                }
            }, 30000);

            try {
                const [up, us] = await Promise.all([fetch(API_URL+'/uploads'), fetch(API_URL+'/')]);
                allVideos = (await up.json()).sort(() => Math.random() - 0.5);
                usersData = await us.json();
                
                clearTimeout(loadingTimeout);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('filtersRow').classList.remove('aurora-line');
                updateAuthUI();
                
                const fRow = document.getElementById('filtersRow');
                [...new Set(allVideos.map(v => v.command))].forEach(cmd => {
                    const btn = document.createElement('button'); 
                    btn.className = 'chip'; 
                    btn.innerText = cmd.replace('!', '');
                    btn.onclick = () => filterMainFeed(cmd, btn);
                    fRow.appendChild(btn);
                });
                renderFeed();
            } catch(e) {}
        }

        document.getElementById('genAuthBtn').onclick = async () => {
            const btn = document.getElementById('genAuthBtn'); btn.disabled = true;
            try {
                const res = await fetch(API_URL + '/auth/generate-code');
                const data = await res.json();
                localStorage.setItem('sessionToken', data.sessionToken);
                document.getElementById('authCodeDisp').innerText = `!connect ${data.connectCode}`;
                document.getElementById('authInstr').classList.remove('hidden'); btn.classList.add('hidden');
                pollInterval = setInterval(checkAuthStatus, 3000);
            } catch (e) { btn.disabled = false; }
        };

        async function checkAuthStatus() {
            const token = localStorage.getItem('sessionToken'); if (!token) return;
            try {
                const res = await fetch(`${API_URL}/auth/status?sessionToken=${token}`);
                const data = await res.json();
                if (data.status === 'completed') {
                    clearInterval(pollInterval);
                    Auth.login(data.userApiKey, data.channelId);
                    location.reload();
                }
            } catch (e) {}
        }

        async function publishCmd(cmd, btn) {
            const title = document.getElementById('pubTitle').value.trim();
            if (title.length < 5) return;
            btn.classList.add('in-cooldown');
            try {
                await fetch(`${API_URL}/publish/${cmd}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userApiKey: Auth.getKey(), title: title }) });
                document.getElementById('pubStatus').innerText = "Success! Content Published.";
                document.getElementById('pubTitle').value = "";
            } catch (e) {} finally { setTimeout(() => btn.classList.remove('in-cooldown'), 2000); }
        }

        function getColorForCommand(cmd) {
            let hash = 0; for (let i = 0; i < cmd.length; i++) hash = cmd.charCodeAt(i) + ((hash << 5) - hash);
            return `linear-gradient(135deg, hsl(${Math.abs(hash % 360)}, 40%, 25%), #000)`;
        }

        function getTimeAgo(t) {
            const s = Math.floor((new Date() - new Date(t)) / 1000);
            if (s < 60) return "just now"; if (s < 3600) return Math.floor(s/60) + "m ago";
            if (s < 86400) return Math.floor(s/3600) + "h ago"; return Math.floor(s/86400) + "d ago";
        }

        function renderFeed() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const vGrid = document.getElementById('videoGrid'); const cRes = document.getElementById('channelResults');
            vGrid.innerHTML = ''; cRes.innerHTML = '';
            document.getElementById('mainView').style.display = 'block'; document.getElementById('channelProfileView').style.display = 'none'; document.getElementById('backBtn').style.display = 'none';
            if(q) {
                Object.entries(usersData).forEach(([handle, data]) => {
                    if (data.displayName?.toLowerCase().includes(q) || handle.toLowerCase().includes(q)) {
                        const row = document.createElement('div'); row.className = "channel-search-row";
                        row.onclick = () => openChannel(data.channelId);
                        row.innerHTML = `<img src="${data.profilePicture || defaultPfp}" class="search-pfp" onerror="this.src='${defaultPfp}';"><div style="display:flex; flex-direction:column; justify-content:center;"><h2 style="margin:0;">${data.displayName}</h2><div style="color:var(--yt-secondary);">${handle} • ${data.subscriberCount.toLocaleString()} subs</div></div>`;
                        cRes.appendChild(row);
                    }
                });
            }
            allVideos.forEach((v, i) => { 
                if ((!q || v.title.toLowerCase().includes(q) || v.username.toLowerCase().includes(q)) && (activeFilter === "All" || v.command === activeFilter)) {
                    vGrid.appendChild(createVideoCard(v, i)); 
                }
            });
        }

        function createVideoCard(v, i) {
            const user = Object.values(usersData).find(u => u.channelId === v.channelId) || {};
            const card = document.createElement('div'); card.className = 'video-card'; card.onclick = () => openChannel(v.channelId);
            card.style.animationDelay = `${Math.min(i * 0.04, 0.8)}s`;
            card.innerHTML = `<div class="thumbnail"><div class="thumb-bg" style="background: ${getColorForCommand(v.command)};"></div><img src="${user.profilePicture || defaultPfp}" class="thumb-overlay-pfp" onerror="this.src='${defaultPfp}';"><span style="position:absolute; bottom:8px; right:8px; background:rgba(0,0,0,0.8); padding:2px 6px; border-radius:4px; font-size:12px; font-weight:700; color:white;">${v.command}</span></div><div class="details"><img src="${user.profilePicture || defaultPfp}" onerror="this.src='${defaultPfp}';"><div><h3 class="title">${v.title}</h3><div style="color:var(--yt-secondary); font-size:12px; margin-top:4px;">${v.username} • <span class="time-label" data-time="${v.timestamp}">${getTimeAgo(v.timestamp)}</span></div></div></div>`;
            return card;
        }

        function openChannel(cid) {
            const userEntry = Object.entries(usersData).find(([h, d]) => d.channelId === cid); if (!userEntry) return;
            const [handle, user] = userEntry; currentHandle = handle;
            document.getElementById('mainView').style.display = 'none'; document.getElementById('channelProfileView').style.display = 'block'; document.getElementById('channelProfileView').style.opacity = "1"; document.getElementById('backBtn').style.display = 'block';
            const chanVids = allVideos.filter(v => v.channelId === cid);
            document.getElementById('profileTop').innerHTML = `<div class="profile-header"><img src="${user.profilePicture || defaultPfp}" class="profile-pfp-circle" onerror="this.src='${defaultPfp}';"><div class="profile-info"><h1>${user.displayName}</h1><div style="color:var(--yt-secondary); margin-top:8px; font-size:14px;">${handle} • ${user.subscriberCount.toLocaleString()} subs • ${chanVids.length} videos</div><button class="btn-gray" onclick="openStudio()">Live Sub Count View</button></div></div>`;
            const tRow = document.getElementById('tabsRow'); tRow.innerHTML = '';
            ['All', ...new Set(chanVids.map(v => v.command))].forEach(cmd => { const btn = document.createElement('div'); btn.className = 'tab' + (cmd === 'All' ? ' active' : ''); btn.innerText = cmd.replace('!', ''); btn.onclick = () => { document.querySelectorAll('#tabsRow .tab').forEach(c => c.classList.remove('active')); btn.classList.add('active'); filterChannelContent(cid, cmd); }; tRow.appendChild(btn); });
            filterChannelContent(cid, 'All');
        }

        function filterChannelContent(cid, filter) { const grid = document.getElementById('channelVideoGrid'); grid.innerHTML = ''; allVideos.filter(v => v.channelId === cid && (filter === 'All' || v.command === filter)).forEach((v, i) => grid.appendChild(createVideoCard(v, i))); }
        function openStudio() { const user = usersData[currentHandle]; document.getElementById('studioPfp').src = user.profilePicture || defaultPfp; document.getElementById('studioName').innerText = user.displayName; updateOdometer(user.subscriberCount); document.getElementById('liveSubCountView').style.display = 'flex'; setTimeout(() => document.getElementById('liveSubCountView').style.opacity = '1', 10); }
        function closeStudio() { document.getElementById('liveSubCountView').style.opacity = '0'; setTimeout(() => document.getElementById('liveSubCountView').style.display = 'none', 500); }
        function handleLogout() { Auth.logout(); }
        function copyAuthCode() { navigator.clipboard.writeText(document.getElementById('authCodeDisp').innerText); alert("Copied!"); }

        function updateOdometer(number) {
            const container = document.getElementById('odometer'); const numStr = number.toLocaleString(); 
            // Now reading the height directly from the CSS variable
            const h = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--odo-h'));
            
            if (container.children.length !== numStr.length) {
                container.innerHTML = ''; digitState.length = 0;
                [...numStr].forEach((char, i) => {
                    const d = document.createElement('div'); d.className = 'odo-digit';
                    if (isNaN(char)) d.innerHTML = `<div class="odo-reel"><span>${char}</span></div>`;
                    else { d.innerHTML = `<div class="odo-reel" style="transition:transform 1.2s var(--odo-easing)">${'01234567890123456789'.split('').map(n => `<span>${n}</span>`).join('')}</div>`; digitState[i] = { pos: parseInt(char) }; }
                    container.appendChild(d); if (digitState[i]) d.querySelector('.odo-reel').style.transform = `translateY(-${digitState[i].pos * h}px)`;
                });
                return;
            }
            [...numStr].forEach((char, i) => { if (isNaN(char)) return; const reel = container.children[i].querySelector('.odo-reel'); const target = parseInt(char); const current = digitState[i].pos; if (target !== current) { let move = target < current ? target + 10 : target; reel.style.transition = "transform 1.2s var(--odo-easing)"; reel.style.transform = `translateY(-${move * h}px)`; setTimeout(() => { reel.style.transition = "none"; reel.style.transform = `translateY(-${target * h}px)`; digitState[i].pos = target; }, 1250); } });
        }

        window.onclick = function(e) { if (!e.target.closest('.user-pfp-btn') && !e.target.closest('.dropdown')) document.getElementById('userDropdown').classList.remove('show'); if (e.target == document.getElementById('authModal')) document.getElementById('authModal').style.display = 'none'; };
        setInterval(async () => { try { const res = await fetch(API_URL + '/'); usersData = await res.json(); if(document.getElementById('liveSubCountView').style.display === 'flex') updateOdometer(usersData[currentHandle].subscriberCount); document.querySelectorAll('.time-label').forEach(l => l.innerText = getTimeAgo(l.dataset.time)); } catch(e){} }, 2000);
        document.getElementById('searchBtn').onclick = renderFeed; document.getElementById('searchInput').onkeypress = (e) => { if(e.key === 'Enter') renderFeed(); };
        document.getElementById('backBtn').onclick = () => { document.getElementById('searchInput').value = ''; renderFeed(); };
        init();
    </script>
</body>
</html>
